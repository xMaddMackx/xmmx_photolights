name: Changelog â†’ Discord

on:
  push:
    branches: [main]
    paths:
      - 'CHANGELOG.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Extract the newest section (first "## " block) from CHANGELOG.md
      - id: extract
        shell: bash
        run: |
          set -eo pipefail
          awk 'BEGIN{p=0}/^##[[:space:]]/{if(p)exit;p=1} p{print}' CHANGELOG.md > latest.md || true
          # Fallback if no "## " headings: last 100 lines
          if [ ! -s latest.md ]; then tail -n 100 CHANGELOG.md > latest.md; fi

          # Single-line title output
          title="$(head -n1 latest.md | sed 's/^##[[:space:]]*//')"
          echo "title=$title" >> "$GITHUB_OUTPUT"

          # Prepare a trimmed description to keep embeds safe (<4096 chars)
          tail -n +2 latest.md | head -c 3800 > description.txt

          # Proper multiline output (UNQUOTED delimiter; closing token alone on a line)
          {
            echo "description<<EOF"
            cat description.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Post to Discord
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.WEBHOOK_URL }}
          username: "Changelog Bot"
          embed-title: ${{ steps.extract.outputs.title }}
          embed-description: ${{ steps.extract.outputs.description }}
          embed-url: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
          filename: latest.md
