name: Changelog â†’ Discord

on:
  push:
    branches: [main]            
    paths:
      - 'CHANGELOG.md'          

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: extract
        name: Extract latest changelog section
        run: |
          awk 'BEGIN{p=0}/^##[[:space:]]/{if(p)exit;p=1} p{print}' CHANGELOG.md > latest.md
          # Fallback if no "## " headings: last 100 lines
          if [ ! -s latest.md ]; then tail -n 100 CHANGELOG.md > latest.md; fi
          # Title = first line without leading "## "
          echo "title=$(head -n1 latest.md | sed 's/^##[[:space:]]*//')" >> "$GITHUB_OUTPUT"
          # Body = everything after the first line (multiline output)
          echo "description<<'EOF'" >> "$GITHUB_OUTPUT"
          sed -e '1d' latest.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Post to Discord
        uses: tsickert/discord-webhook@v7
        with:
          webhook-url: ${{ secrets.WEBHOOK_URL }}
          username: "Changelog Bot"
          embed-title: ${{ steps.extract.outputs.title }}
          embed-description: ${{ steps.extract.outputs.description }}
          embed-url: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
          filename: latest.md                      
